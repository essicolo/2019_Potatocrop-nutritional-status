<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 4 Perturbation vector theory | Nutrient Diagnosis Of Potato</title>
  <meta name="description" content="This is a example of using the bookdown package to write a book that describ the statistical computations of my PhD Project, for publication on Github. The output format choosed is bookdown::gitbook. Next features are set out for after (bibliography and links)." />
  <meta name="generator" content="bookdown 0.10 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 4 Perturbation vector theory | Nutrient Diagnosis Of Potato" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="This is a example of using the bookdown package to write a book that describ the statistical computations of my PhD Project, for publication on Github. The output format choosed is bookdown::gitbook. Next features are set out for after (bibliography and links)." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 4 Perturbation vector theory | Nutrient Diagnosis Of Potato" />
  
  <meta name="twitter:description" content="This is a example of using the bookdown package to write a book that describ the statistical computations of my PhD Project, for publication on Github. The output format choosed is bookdown::gitbook. Next features are set out for after (bibliography and links)." />
  

<meta name="author" content="zcoulibali" />


<meta name="date" content="2019-06-20" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="Chapter-Modeling.html">
<link rel="next" href="references.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />









<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">A Minimal Book Example</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Data processing</a><ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#Objective"><i class="fa fa-check"></i><b>1.1</b> Objective</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#useful-libraries-for-data-handling"><i class="fa fa-check"></i><b>1.2</b> Useful libraries for data handling</a></li>
<li class="chapter" data-level="1.3" data-path="index.html"><a href="index.html#quebec-potato-data-set"><i class="fa fa-check"></i><b>1.3</b> Qu√©bec potato data set</a></li>
<li class="chapter" data-level="1.4" data-path="index.html"><a href="index.html#selection-of-useful-variables"><i class="fa fa-check"></i><b>1.4</b> Selection of useful variables</a></li>
<li class="chapter" data-level="1.5" data-path="index.html"><a href="index.html#arranging-the-data-frame"><i class="fa fa-check"></i><b>1.5</b> Arranging the data frame</a></li>
<li class="chapter" data-level="1.6" data-path="index.html"><a href="index.html#cultivar-classes-correction"><i class="fa fa-check"></i><b>1.6</b> Cultivar classes correction</a></li>
<li class="chapter" data-level="1.7" data-path="index.html"><a href="index.html#summarise-and-backup"><i class="fa fa-check"></i><b>1.7</b> Summarise and backup</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="Chapter-Clustering.html"><a href="Chapter-Clustering.html"><i class="fa fa-check"></i><b>2</b> Cluster analysis of potato cultivars</a><ul>
<li class="chapter" data-level="2.1" data-path="Chapter-Clustering.html"><a href="Chapter-Clustering.html#objective"><i class="fa fa-check"></i><b>2.1</b> Objective</a></li>
<li class="chapter" data-level="2.2" data-path="Chapter-Clustering.html"><a href="Chapter-Clustering.html#useful-libraries-and-custom-functions"><i class="fa fa-check"></i><b>2.2</b> Useful libraries and custom functions</a></li>
<li class="chapter" data-level="2.3" data-path="Chapter-Clustering.html"><a href="Chapter-Clustering.html#leaves-processed-compositions-data-set"><i class="fa fa-check"></i><b>2.3</b> Leaves processed compositions data set</a></li>
<li class="chapter" data-level="2.4" data-path="Chapter-Clustering.html"><a href="Chapter-Clustering.html#high-yielders-delimiter"><i class="fa fa-check"></i><b>2.4</b> High yielders delimiter</a></li>
<li class="chapter" data-level="2.5" data-path="Chapter-Clustering.html"><a href="Chapter-Clustering.html#centered-log-ratio-clr-centroids-computation"><i class="fa fa-check"></i><b>2.5</b> Centered log-ratio (clr) centroids computation</a></li>
<li class="chapter" data-level="2.6" data-path="Chapter-Clustering.html"><a href="Chapter-Clustering.html#axis-reduction"><i class="fa fa-check"></i><b>2.6</b> Axis reduction</a></li>
<li class="chapter" data-level="2.7" data-path="Chapter-Clustering.html"><a href="Chapter-Clustering.html#cascade-k-means-clustering"><i class="fa fa-check"></i><b>2.7</b> Cascade K Means clustering</a></li>
<li class="chapter" data-level="2.8" data-path="Chapter-Clustering.html"><a href="Chapter-Clustering.html#arranging-data-for-machine-learning"><i class="fa fa-check"></i><b>2.8</b> Arranging data for Machine Learning</a></li>
<li class="chapter" data-level="2.9" data-path="Chapter-Clustering.html"><a href="Chapter-Clustering.html#clr-x-ionomics-groups-interactions-effects"><i class="fa fa-check"></i><b>2.9</b> clr x ionomics groups interactions effects</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="Chapter-Modeling.html"><a href="Chapter-Modeling.html"><i class="fa fa-check"></i><b>3</b> Predicting tuber yield category</a><ul>
<li class="chapter" data-level="3.1" data-path="Chapter-Modeling.html"><a href="Chapter-Modeling.html#objective-1"><i class="fa fa-check"></i><b>3.1</b> Objective</a></li>
<li class="chapter" data-level="3.2" data-path="Chapter-Modeling.html"><a href="Chapter-Modeling.html#useful-libraries"><i class="fa fa-check"></i><b>3.2</b> Useful libraries</a></li>
<li class="chapter" data-level="3.3" data-path="Chapter-Modeling.html"><a href="Chapter-Modeling.html#machine-learning-data-set"><i class="fa fa-check"></i><b>3.3</b> Machine learning data set</a></li>
<li class="chapter" data-level="3.4" data-path="Chapter-Modeling.html"><a href="Chapter-Modeling.html#processing-machine-learning"><i class="fa fa-check"></i><b>3.4</b> Processing Machine learning</a><ul>
<li class="chapter" data-level="3.4.1" data-path="Chapter-Modeling.html"><a href="Chapter-Modeling.html#train-and-test-splits"><i class="fa fa-check"></i><b>3.4.1</b> Train and Test splits</a></li>
<li class="chapter" data-level="3.4.2" data-path="Chapter-Modeling.html"><a href="Chapter-Modeling.html#building-the-models"><i class="fa fa-check"></i><b>3.4.2</b> Building the Models</a></li>
<li class="chapter" data-level="3.4.3" data-path="Chapter-Modeling.html"><a href="Chapter-Modeling.html#goodness-of-fit-on-training-set"><i class="fa fa-check"></i><b>3.4.3</b> Goodness of fit on training set</a></li>
<li class="chapter" data-level="3.4.4" data-path="Chapter-Modeling.html"><a href="Chapter-Modeling.html#models-evaluation-on-testing-set"><i class="fa fa-check"></i><b>3.4.4</b> Models‚Äô evaluation (on testing set)</a></li>
</ul></li>
<li class="chapter" data-level="3.5" data-path="Chapter-Modeling.html"><a href="Chapter-Modeling.html#yield-class-prediction-with-rf-algorithm"><i class="fa fa-check"></i><b>3.5</b> Yield class prediction with rf algorithm</a></li>
<li class="chapter" data-level="3.6" data-path="Chapter-Modeling.html"><a href="Chapter-Modeling.html#comparison-with-non-informative-classification"><i class="fa fa-check"></i><b>3.6</b> Comparison with non-informative classification</a></li>
<li class="chapter" data-level="3.7" data-path="Chapter-Modeling.html"><a href="Chapter-Modeling.html#train-data-set-backup-for-tn-specimens-selection"><i class="fa fa-check"></i><b>3.7</b> Train data set backup for TN specimens selection</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="Chapter-Perturbation-vector.html"><a href="Chapter-Perturbation-vector.html"><i class="fa fa-check"></i><b>4</b> Perturbation vector theory</a><ul>
<li class="chapter" data-level="4.1" data-path="Chapter-Perturbation-vector.html"><a href="Chapter-Perturbation-vector.html#objective-2"><i class="fa fa-check"></i><b>4.1</b> Objective</a></li>
<li class="chapter" data-level="4.2" data-path="Chapter-Perturbation-vector.html"><a href="Chapter-Perturbation-vector.html#data-set-and-useful-libraries"><i class="fa fa-check"></i><b>4.2</b> Data set and useful libraries</a></li>
<li class="chapter" data-level="4.3" data-path="Chapter-Perturbation-vector.html"><a href="Chapter-Perturbation-vector.html#dissimilarity-index-between-compositions"><i class="fa fa-check"></i><b>4.3</b> Dissimilarity index between compositions</a></li>
<li class="chapter" data-level="4.4" data-path="Chapter-Perturbation-vector.html"><a href="Chapter-Perturbation-vector.html#rebalancing-a-misbalanced-sample-by-perturbation"><i class="fa fa-check"></i><b>4.4</b> Rebalancing a misbalanced sample by perturbation</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Nutrient Diagnosis Of Potato</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="Chapter-Perturbation-vector" class="section level1">
<h1><span class="header-section-number">Chapter 4</span> Perturbation vector theory</h1>
<div id="objective-2" class="section level2">
<h2><span class="header-section-number">4.1</span> Objective</h2>
<hr />
<p>The objective of this chapter is to develop a mathematical workflow useful to adjust the ionome of potato crops for diagnostic purpose. Perturbation in compositional space plays the same role as translation plays in real space. Some natural processes in nature can be interpreted as a change from one composition <code>C1</code> to another <code>C2</code> through the application of a perturbation:</p>
<blockquote>
<p><code>p ‚äï C1 ====&gt; C2</code>.</p>
</blockquote>
<p>The difference between <code>the new observation</code> and the closest TN composition can be back-transformed to the compositional space. The obtained vector is the <code>perturbation vector</code>. Theoretically, a misbalanced composition could be balanced (translated into a healthy zone) using a perturbation vector. Also, ionome of a new cultivar could be assigned to the closest healthy ionomics group where nutrient requirements have been already documented by fertilizer trials.</p>
<p>I compute a dissimilarity index using the true negative clr as reference. Then, I describe the procedure used to rebalance a misbalanced composition and finally present the results using ggplot2 functions.</p>
<hr />
</div>
<div id="data-set-and-useful-libraries" class="section level2">
<h2><span class="header-section-number">4.2</span> Data set and useful libraries</h2>
<p>We need package <a href="https://www.rdocumentation.org/packages/compositions/versions/1.40-2">compositions</a> for further clr back-transformation de compositional space. The package <a href="https://cran.r-project.org/web/packages/reshape/index.html">reshape</a> will be used to melt an intermediate data frame. As explained at the end of the Chapter <a href="Chapter-Modeling.html#Chapter-Modeling">3</a>, I consider as True Negatives (TN) specimens (or healthy points) for this study, observations of the <code>training data set</code> having a high yield (HY) and correctly predicted by the random forest model.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">&quot;tidyverse&quot;</span>)
<span class="kw">library</span>(<span class="st">&quot;extrafont&quot;</span>)
<span class="kw">library</span>(<span class="st">&#39;compositions&#39;</span>)
<span class="kw">library</span>(<span class="st">&quot;reshape&quot;</span>)
train_df =<span class="st"> </span><span class="kw">read_csv</span>(<span class="st">&quot;output/train_df.csv&quot;</span>)
train_df<span class="op">$</span>group_i =<span class="st"> </span><span class="kw">factor</span>(train_df<span class="op">$</span>group_i)
TNs =<span class="st"> </span>train_df[train_df<span class="op">$</span>yieldClass <span class="op">==</span><span class="st"> &#39;HY&#39;</span> <span class="op">&amp;</span><span class="st"> </span>train_df<span class="op">$</span>pred_yield <span class="op">==</span><span class="st"> &#39;HY&#39;</span>, ]
clrNo =<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;clrN&quot;</span>, <span class="st">&quot;clrP&quot;</span>, <span class="st">&quot;clrK&quot;</span>, <span class="st">&quot;clrCa&quot;</span>, <span class="st">&quot;clrMg&quot;</span>, <span class="st">&quot;clrFv&quot;</span>) <span class="co"># for simplicity</span></code></pre></div>
</div>
<div id="dissimilarity-index-between-compositions" class="section level2">
<h2><span class="header-section-number">4.3</span> Dissimilarity index between compositions</h2>
<p>The first step is to compute a dissimilarity index according to the distance from the closest healthy point (the closest TN). I use the Euclidean distance between clr composition as the dissimilarity index. The chunk below shows the custom function used to compute euclidean distance.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">eucl_dist_f &lt;-<span class="st"> </span><span class="cf">function</span>(x, y) {
    <span class="kw">sqrt</span>(<span class="kw">sum</span>((x<span class="op">-</span>y)<span class="op">^</span><span class="dv">2</span>))
}</code></pre></div>
<p>For each unbalanced composition, I use the next loop to compute all the euclidean distances between all the compositions in ‚ÄúTNs‚Äù of the corresponding group. The computation is possible even if the ionomics groups is unknown. The loop returns the smallest Euclidean distance as the unbalanced index of that composition. The computed debalance (or imbalance) index is stored by a new vector <code>debal</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">debal &lt;-<span class="st"> </span><span class="kw">c</span>()
debal_index &lt;-<span class="st"> </span><span class="kw">c</span>()
<span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(train_df)) {
    clr_i &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(train_df[i, clrNo])
    eucl_dist &lt;-<span class="st"> </span><span class="kw">apply</span>(TNs <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(group_i <span class="op">==</span><span class="st"> </span>train_df<span class="op">$</span>group_i[i]) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(clrNo), 
                       <span class="dv">1</span>, <span class="cf">function</span>(x) <span class="kw">eucl_dist_f</span>(<span class="dt">x=</span>x, <span class="dt">y=</span>clr_i))
    debal_index[i] &lt;-<span class="st"> </span><span class="kw">which.min</span>(eucl_dist)
    debal[i] &lt;-<span class="st"> </span>eucl_dist[debal_index[i]]
}
train_df<span class="op">$</span>debal &lt;-<span class="st"> </span>debal
train_df <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">glimpse</span>()</code></pre></div>
<pre><code>## Observations: 2,537
## Variables: 17
## $ NoEssai      &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1...
## $ NoBloc       &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3...
## $ NoTraitement &lt;dbl&gt; 1, 2, 4, 6, 7, 8, 2, 3, 4, 6, 7, 1, 2, 4, 6, 7, 8...
## $ clrN         &lt;dbl&gt; 0.3321186, 0.4252302, 0.3993264, 0.4885647, 0.720...
## $ clrP         &lt;dbl&gt; -2.518325, -2.394957, -2.599180, -2.525335, -2.30...
## $ clrK         &lt;dbl&gt; 0.8379383, 1.1387291, 0.7945826, 0.9418880, 0.720...
## $ clrMg        &lt;dbl&gt; -1.639076, -2.346167, -1.577529, -1.763195, -1.70...
## $ clrCa        &lt;dbl&gt; -0.4794688, -0.5154924, -0.6220171, -0.6426036, -...
## $ clrFv        &lt;dbl&gt; 3.466813, 3.692658, 3.604817, 3.500681, 3.432323,...
## $ Cultivar     &lt;chr&gt; &quot;Goldrush&quot;, &quot;Goldrush&quot;, &quot;Goldrush&quot;, &quot;Goldrush&quot;, &quot;...
## $ Maturity5    &lt;chr&gt; &quot;mid-season&quot;, &quot;mid-season&quot;, &quot;mid-season&quot;, &quot;mid-se...
## $ RendVendable &lt;dbl&gt; 18.94420, 40.35180, 37.55050, 41.01670, 46.79370,...
## $ yieldCutoff  &lt;dbl&gt; 41.33053, 41.33053, 41.33053, 41.33053, 41.33053,...
## $ yieldClass   &lt;chr&gt; &quot;LY&quot;, &quot;LY&quot;, &quot;LY&quot;, &quot;LY&quot;, &quot;HY&quot;, &quot;HY&quot;, &quot;LY&quot;, &quot;HY&quot;, &quot;...
## $ group_i      &lt;fct&gt; 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2...
## $ pred_yield   &lt;chr&gt; &quot;LY&quot;, &quot;LY&quot;, &quot;LY&quot;, &quot;LY&quot;, &quot;HY&quot;, &quot;HY&quot;, &quot;LY&quot;, &quot;HY&quot;, &quot;...
## $ debal        &lt;dbl&gt; 0.2915435, 0.3247296, 0.2628167, 0.2987338, 0.000...</code></pre>
</div>
<div id="rebalancing-a-misbalanced-sample-by-perturbation" class="section level2">
<h2><span class="header-section-number">4.4</span> Rebalancing a misbalanced sample by perturbation</h2>
<p>Let‚Äôs suppose that we got this point selected at random in <code>unbalanced specimens</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">set.seed</span>(<span class="dv">932559</span>) 
unbalanced &lt;-<span class="st"> </span><span class="kw">subset</span>(train_df, debal <span class="op">!=</span><span class="dv">0</span>)
unbalanced &lt;-<span class="st"> </span>unbalanced[<span class="kw">sample</span>(<span class="kw">nrow</span>(unbalanced), <span class="dv">1</span>), ]
<span class="kw">t</span>(unbalanced)</code></pre></div>
<pre><code>##              [,1]        
## NoEssai      &quot;355&quot;       
## NoBloc       &quot;1&quot;         
## NoTraitement &quot;2&quot;         
## clrN         &quot;0.8015935&quot; 
## clrP         &quot;-2.00352&quot;  
## clrK         &quot;0.1670366&quot; 
## clrMg        &quot;-1.563568&quot; 
## clrCa        &quot;-0.8453153&quot;
## clrFv        &quot;3.443773&quot;  
## Cultivar     &quot;Mystere&quot;   
## Maturity5    &quot;late&quot;      
## RendVendable &quot;33.14916&quot;  
## yieldCutoff  &quot;33.63704&quot;  
## yieldClass   &quot;LY&quot;        
## group_i      &quot;1&quot;         
## pred_yield   &quot;LY&quot;        
## debal        &quot;0.08489367&quot;</code></pre>
<p>Or even, we could rather use the most unbalanced occurrence, why not !</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">unbalanced &lt;-<span class="st"> </span><span class="kw">subset</span>(train_df, debal <span class="op">!=</span><span class="dv">0</span>)
unbalanced &lt;-<span class="st"> </span>unbalanced[<span class="kw">which.max</span>(unbalanced<span class="op">$</span>debal), ]
misbalanced &lt;-<span class="st"> </span>unbalanced <span class="co"># copy</span>
<span class="kw">t</span>(misbalanced)</code></pre></div>
<pre><code>##              [,1]              
## NoEssai      &quot;200&quot;             
## NoBloc       &quot;1&quot;               
## NoTraitement &quot;2&quot;               
## clrN         &quot;0.957698&quot;        
## clrP         &quot;-1.83199&quot;        
## clrK         &quot;-0.04637332&quot;     
## clrMg        &quot;-2.247862&quot;       
## clrCa        &quot;0.4678508&quot;       
## clrFv        &quot;2.700677&quot;        
## Cultivar     &quot;Superior&quot;        
## Maturity5    &quot;early mid-season&quot;
## RendVendable &quot;30.37194&quot;        
## yieldCutoff  &quot;32.6&quot;            
## yieldClass   &quot;LY&quot;              
## group_i      &quot;1&quot;               
## pred_yield   &quot;LY&quot;              
## debal        &quot;1.256154&quot;</code></pre>
<p>How could we rebalance it? The first step is to find <code>in TNs of the corresponding ionomic group</code> the closest balanced point. Let‚Äôs re-compute its Euclidean distances from TNs and identify the sample from which the distance is minimum.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">misbalanced &lt;-<span class="st"> </span>misbalanced[clrNo]
eucl_dist_misbal &lt;-<span class="st"> </span><span class="kw">apply</span>(TNs[, clrNo], <span class="dv">1</span>, <span class="cf">function</span>(x) <span class="kw">eucl_dist_f</span>(<span class="dt">x=</span>x, <span class="dt">y=</span>misbalanced))
index_misbal &lt;-<span class="st"> </span><span class="kw">which.min</span>(<span class="kw">t</span>(<span class="kw">data.frame</span>(eucl_dist_misbal))) 
index_misbal <span class="co"># return the index of the sample</span></code></pre></div>
<pre><code>## [1] 610</code></pre>
<p>The closest healthy sample is the one which index is 610. Using this index we could refind the <code>debal</code> value of the misbalanced sample for check.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">(<span class="dt">misbal =</span> eucl_dist_misbal[index_misbal])</code></pre></div>
<pre><code>## [1] 1.256154</code></pre>
<p>The Euclidean distance matches with the corresponding <code>debal</code> value: <code>unbalanced$debal[1]</code> = 1.2561535.</p>
<p>The <code>closest point in the TNs</code> subset is this one:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">closest &lt;-<span class="st"> </span>TNs[index_misbal, ]
<span class="kw">t</span>(closest)</code></pre></div>
<pre><code>##              [,1]              
## NoEssai      &quot;196&quot;             
## NoBloc       &quot;3&quot;               
## NoTraitement &quot;6&quot;               
## clrN         &quot;0.6219769&quot;       
## clrP         &quot;-2.544439&quot;       
## clrK         &quot;0.3293346&quot;       
## clrMg        &quot;-1.635584&quot;       
## clrCa        &quot;0.02902074&quot;      
## clrFv        &quot;3.199691&quot;        
## Cultivar     &quot;Superior&quot;        
## Maturity5    &quot;early mid-season&quot;
## RendVendable &quot;41.2204&quot;         
## yieldCutoff  &quot;32.6&quot;            
## yieldClass   &quot;HY&quot;              
## group_i      &quot;1&quot;               
## pred_yield   &quot;HY&quot;</code></pre>
<p>Note that ionomics groups of the misbalanced and the closest healthy composition are the same. I compute the clr difference between the closest and the misbalanced points.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">closest =<span class="st"> </span>closest[clrNo]
clr_diff =<span class="st"> </span>closest <span class="op">-</span><span class="st"> </span>misbalanced
<span class="kw">t</span>(clr_diff)</code></pre></div>
<pre><code>##             [,1]
## clrN  -0.3357211
## clrP  -0.7124496
## clrK   0.3757079
## clrCa -0.4388300
## clrMg  0.6122787
## clrFv  0.4990141</code></pre>
<p>The perturbation vector is that clr difference back-transformed to leaf compositional space.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">comp_names &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;N&quot;</span>, <span class="st">&quot;P&quot;</span>, <span class="st">&quot;K&quot;</span>, <span class="st">&quot;Ca&quot;</span>, <span class="st">&quot;Mg&quot;</span>, <span class="st">&quot;Fv&quot;</span>)
perturbation_vector &lt;-<span class="st"> </span><span class="kw">clrInv</span>(clr_diff)
<span class="kw">names</span>(perturbation_vector) &lt;-<span class="st"> </span>comp_names
<span class="kw">t</span>(perturbation_vector)</code></pre></div>
<pre><code>##    [,1]      
## N  0.10515492
## P  0.07214704
## K  0.21419006
## Ca 0.09485276
## Mg 0.27135681
## Fv 0.24229840
## attr(,&quot;class&quot;)
## [1] acomp</code></pre>
<p>Next, we should compute the compositions of the clr coordinates of the misbalanced point, as well as the closest TN point. The vectors could be gathered in a table made up of perturbation vector, misbalanced composition and the closest reference sample (pmc).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">misbal_comp &lt;-<span class="st"> </span><span class="kw">clrInv</span>(misbalanced)
<span class="kw">names</span>(misbal_comp) &lt;-<span class="st"> </span>comp_names

closest_comp &lt;-<span class="st"> </span><span class="kw">clrInv</span>(closest)
<span class="kw">names</span>(closest_comp) &lt;-<span class="st"> </span>comp_names

pmc =<span class="st"> </span><span class="kw">rbind</span>(perturbation_vector, misbal_comp, closest_comp)
<span class="kw">rownames</span>(pmc) =<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;perturbation_vector&quot;</span>,<span class="st">&quot;misbal_comp&quot;</span>,<span class="st">&quot;closest_comp&quot;</span>)
pmc</code></pre></div>
<pre><code>##                              N           P         K         Ca        Mg
## perturbation_vector 0.10515492 0.072147042 0.2141901 0.09485276 0.2713568
## misbal_comp         0.12828046 0.007881602 0.0470000 0.07860000 0.0052000
## closest_comp        0.06405025 0.002700000 0.0478000 0.03540000 0.0067000
##                            Fv
## perturbation_vector 0.2422984
## misbal_comp         0.7330379
## closest_comp        0.8433497</code></pre>
<p>We could even check that the simplex is closed to 1 for each vector.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">sum</span>(perturbation_vector); <span class="kw">sum</span>(misbal_comp); <span class="kw">sum</span>(closest_comp)</code></pre></div>
<pre><code>## [1] 1</code></pre>
<pre><code>## [1] 1</code></pre>
<pre><code>## [1] 1</code></pre>
<p>The closest composition minus the misbalanced composition should return the perturbation vector.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">print</span>(closest_comp <span class="op">-</span><span class="st"> </span>misbal_comp) <span class="co"># soustraction</span></code></pre></div>
<pre><code>##      N         P          K         Ca         Mg        Fv       
## [1,] 0.1051549 0.07214704 0.2141901 0.09485276 0.2713568 0.2422984
## attr(,&quot;class&quot;)
## [1] acomp</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">print</span>(perturbation_vector)        <span class="co"># for comparison</span></code></pre></div>
<pre><code>##      N         P          K         Ca         Mg        Fv       
## [1,] 0.1051549 0.07214704 0.2141901 0.09485276 0.2713568 0.2422984
## attr(,&quot;class&quot;)
## [1] acomp</code></pre>
<p>Or even, perturb the misbalanced point by the perturbation vector, you should obtain the closest TN point:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">print</span>(misbal_comp <span class="op">+</span><span class="st"> </span>perturbation_vector) <span class="co"># perturbation</span></code></pre></div>
<pre><code>##      N          P      K      Ca     Mg     Fv       
## [1,] 0.06405025 0.0027 0.0478 0.0354 0.0067 0.8433497
## attr(,&quot;class&quot;)
## [1] acomp</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">print</span>(closest_comp)                      <span class="co"># for comparison</span></code></pre></div>
<pre><code>##      N          P      K      Ca     Mg     Fv       
## [1,] 0.06405025 0.0027 0.0478 0.0354 0.0067 0.8433497
## attr(,&quot;class&quot;)
## [1] acomp</code></pre>
<p>So, the assumption is true. The next codes show the concept using plots. I aranged a data frame for ggplot.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">df =<span class="st"> </span><span class="kw">data.frame</span>(<span class="kw">rbind</span>(misbalanced, closest, clr_diff)) <span class="co"># mis, cl, per</span>
vectors =<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;observation&quot;</span>, <span class="st">&quot;reference&quot;</span>, <span class="st">&quot;perturbation&quot;</span>)
df<span class="op">$</span>vectors =<span class="st"> </span><span class="kw">factor</span>(vectors)
dfreshape =<span class="st"> </span><span class="kw">melt</span>(df) <span class="co"># reshapes df for ggplot</span></code></pre></div>
<pre><code>## Using vectors as id variables</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dfreshape</code></pre></div>
<pre><code>##         vectors variable       value
## 1   observation     clrN  0.95769802
## 2     reference     clrN  0.62197688
## 3  perturbation     clrN -0.33572114
## 4   observation     clrP -1.83198972
## 5     reference     clrP -2.54443931
## 6  perturbation     clrP -0.71244958
## 7   observation     clrK -0.04637332
## 8     reference     clrK  0.32933456
## 9  perturbation     clrK  0.37570788
## 10  observation    clrCa  0.46785078
## 11    reference    clrCa  0.02902074
## 12 perturbation    clrCa -0.43883004
## 13  observation    clrMg -2.24786229
## 14    reference    clrMg -1.63558355
## 15 perturbation    clrMg  0.61227874
## 16  observation    clrFv  2.70067654
## 17    reference    clrFv  3.19969068
## 18 perturbation    clrFv  0.49901414</code></pre>
<p>The next two chunks plot with dots and histograms for each vector. Visualization is better with histograms.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(<span class="dt">data =</span> dfreshape, <span class="kw">aes</span>(<span class="dt">x =</span> value, <span class="dt">y =</span> vectors)) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_point</span>() <span class="op">+</span>
<span class="st">    </span><span class="kw">facet_wrap</span>(<span class="op">~</span><span class="st"> </span>variable, <span class="dt">scales =</span> <span class="st">&quot;free_x&quot;</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">labs</span>(<span class="dt">x=</span><span class="st">&#39;clr coordinate&#39;</span>, <span class="dt">y =</span><span class="st">&#39;&#39;</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">theme</span>(<span class="dt">text=</span><span class="kw">element_text</span>(<span class="dt">family=</span><span class="st">&quot;Arial&quot;</span>, <span class="dt">face=</span><span class="st">&quot;bold&quot;</span>, <span class="dt">size=</span><span class="dv">12</span>))</code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:hi-perturb-dotplot"></span>
<img src="2019_Bookdown_files/figure-html/hi-perturb-dotplot-1.png" alt="Perturbation vector computation example dotplot using the most imbalanced foliar sample." width="100%" />
<p class="caption">
Figure 4.1: Perturbation vector computation example dotplot using the most imbalanced foliar sample.
</p>
</div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#ggsave(&quot;images/perturb_dotplot.tiff&quot;,  width = 6, height = 3)</span></code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(<span class="dt">data=</span>dfreshape, <span class="kw">aes</span>(<span class="dt">x=</span>variable, <span class="dt">y=</span>value, <span class="dt">fill=</span>vectors)) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_bar</span>(<span class="dt">stat=</span><span class="st">&quot;identity&quot;</span>, <span class="dt">position=</span><span class="kw">position_dodge</span>()) <span class="op">+</span>
<span class="st">    </span><span class="kw">coord_flip</span>() <span class="op">+</span>
<span class="st">    </span><span class="kw">theme_bw</span>() <span class="op">+</span>
<span class="st">    </span><span class="kw">theme</span>(<span class="dt">legend.title=</span><span class="kw">element_blank</span>()) <span class="op">+</span>
<span class="st">    </span><span class="kw">theme</span>(<span class="dt">text=</span><span class="kw">element_text</span>(<span class="dt">family=</span><span class="st">&quot;Arial&quot;</span>, <span class="dt">face=</span><span class="st">&quot;bold&quot;</span>, <span class="dt">size=</span><span class="dv">12</span>))</code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:hi-perturb-barplot"></span>
<img src="2019_Bookdown_files/figure-html/hi-perturb-barplot-1.png" alt="Perturbation vector computation example barplot using the most imbalanced foliar sample." width="100%" />
<p class="caption">
Figure 4.2: Perturbation vector computation example barplot using the most imbalanced foliar sample.
</p>
</div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#ggsave(&quot;images/perturb_barplot.tiff&quot;,  width = 6, height = 3)</span></code></pre></div>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="Chapter-Modeling.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="references.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"download": ["2019_Bookdown.pdf", "2019_Bookdown.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
