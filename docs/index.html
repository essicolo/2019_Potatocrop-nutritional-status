<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Assessment of the nutritional imbalance status of potato crop</title>
  <meta name="description" content="I use the bookdown package to write a book that describs the statistical computations of my PhD Project, for publication on Github. The output format choosed is bookdown::gitbook." />
  <meta name="generator" content="bookdown 0.10 and GitBook 2.6.7" />

  <meta property="og:title" content="Assessment of the nutritional imbalance status of potato crop" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="I use the bookdown package to write a book that describs the statistical computations of my PhD Project, for publication on Github. The output format choosed is bookdown::gitbook." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Assessment of the nutritional imbalance status of potato crop" />
  
  <meta name="twitter:description" content="I use the bookdown package to write a book that describs the statistical computations of my PhD Project, for publication on Github. The output format choosed is bookdown::gitbook." />
  

<meta name="author" content="Zonlehoua Coulibali and Serge-Étienne Parent" />


<meta name="date" content="2019-07-25" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  

<link rel="next" href="Chapter-Clustering.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />









<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">A Minimal Book Example</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Data processing</a><ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#objective"><i class="fa fa-check"></i><b>1.1</b> Objective</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#useful-libraries-for-data-handling"><i class="fa fa-check"></i><b>1.2</b> Useful libraries for data handling</a></li>
<li class="chapter" data-level="1.3" data-path="index.html"><a href="index.html#quebec-potato-data-set"><i class="fa fa-check"></i><b>1.3</b> Québec potato data set</a></li>
<li class="chapter" data-level="1.4" data-path="index.html"><a href="index.html#selection-of-useful-variables"><i class="fa fa-check"></i><b>1.4</b> Selection of useful variables</a></li>
<li class="chapter" data-level="1.5" data-path="index.html"><a href="index.html#arranging-the-data-frame"><i class="fa fa-check"></i><b>1.5</b> Arranging the data frame</a></li>
<li class="chapter" data-level="1.6" data-path="index.html"><a href="index.html#cultivar-classes-correction"><i class="fa fa-check"></i><b>1.6</b> Cultivar classes correction</a></li>
<li class="chapter" data-level="1.7" data-path="index.html"><a href="index.html#summarise-and-backup"><i class="fa fa-check"></i><b>1.7</b> Summarise and backup</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="Chapter-Clustering.html"><a href="Chapter-Clustering.html"><i class="fa fa-check"></i><b>2</b> Ionome analysis</a><ul>
<li class="chapter" data-level="2.1" data-path="Chapter-Clustering.html"><a href="Chapter-Clustering.html#objective-1"><i class="fa fa-check"></i><b>2.1</b> Objective</a></li>
<li class="chapter" data-level="2.2" data-path="Chapter-Clustering.html"><a href="Chapter-Clustering.html#useful-libraries-and-custom-functions"><i class="fa fa-check"></i><b>2.2</b> Useful libraries and custom functions</a></li>
<li class="chapter" data-level="2.3" data-path="Chapter-Clustering.html"><a href="Chapter-Clustering.html#leaves-processed-compositions-data-set"><i class="fa fa-check"></i><b>2.3</b> Leaves processed compositions data set</a></li>
<li class="chapter" data-level="2.4" data-path="Chapter-Clustering.html"><a href="Chapter-Clustering.html#the-yield-cut-off-low-and-high-yielders-delimiter"><i class="fa fa-check"></i><b>2.4</b> The yield cut-off, low and high yielders delimiter</a></li>
<li class="chapter" data-level="2.5" data-path="Chapter-Clustering.html"><a href="Chapter-Clustering.html#centered-log-ratio-clr-centroids-computation"><i class="fa fa-check"></i><b>2.5</b> Centered log-ratio (clr) centroids computation</a></li>
<li class="chapter" data-level="2.6" data-path="Chapter-Clustering.html"><a href="Chapter-Clustering.html#clustering-potato-cultivars-with-ionome"><i class="fa fa-check"></i><b>2.6</b> Clustering potato cultivars with ionome</a></li>
<li class="chapter" data-level="2.7" data-path="Chapter-Clustering.html"><a href="Chapter-Clustering.html#axis-reduction"><i class="fa fa-check"></i><b>2.7</b> Axis reduction</a></li>
<li class="chapter" data-level="2.8" data-path="Chapter-Clustering.html"><a href="Chapter-Clustering.html#do-clrs-affect-potato-tuber-yield"><i class="fa fa-check"></i><b>2.8</b> Do clrs affect potato tuber yield?</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="Chapter-Modeling.html"><a href="Chapter-Modeling.html"><i class="fa fa-check"></i><b>3</b> Predicting tuber yield category</a><ul>
<li class="chapter" data-level="3.1" data-path="Chapter-Modeling.html"><a href="Chapter-Modeling.html#objective-2"><i class="fa fa-check"></i><b>3.1</b> Objective</a></li>
<li class="chapter" data-level="3.2" data-path="Chapter-Modeling.html"><a href="Chapter-Modeling.html#useful-libraries"><i class="fa fa-check"></i><b>3.2</b> Useful libraries</a></li>
<li class="chapter" data-level="3.3" data-path="Chapter-Modeling.html"><a href="Chapter-Modeling.html#machine-learning-data-set"><i class="fa fa-check"></i><b>3.3</b> Machine learning data set</a></li>
<li class="chapter" data-level="3.4" data-path="Chapter-Modeling.html"><a href="Chapter-Modeling.html#machine-learning"><i class="fa fa-check"></i><b>3.4</b> Machine learning</a><ul>
<li class="chapter" data-level="3.4.1" data-path="Chapter-Modeling.html"><a href="Chapter-Modeling.html#data-train-and-test-splits"><i class="fa fa-check"></i><b>3.4.1</b> Data train and test splits</a></li>
<li class="chapter" data-level="3.4.2" data-path="Chapter-Modeling.html"><a href="Chapter-Modeling.html#building-the-models"><i class="fa fa-check"></i><b>3.4.2</b> Building the Models</a></li>
<li class="chapter" data-level="3.4.3" data-path="Chapter-Modeling.html"><a href="Chapter-Modeling.html#goodness-of-fit-on-training-set"><i class="fa fa-check"></i><b>3.4.3</b> Goodness of fit on training set</a></li>
<li class="chapter" data-level="3.4.4" data-path="Chapter-Modeling.html"><a href="Chapter-Modeling.html#models-evaluation-test-set"><i class="fa fa-check"></i><b>3.4.4</b> Models’ evaluation (test set)</a></li>
</ul></li>
<li class="chapter" data-level="3.5" data-path="Chapter-Modeling.html"><a href="Chapter-Modeling.html#estimate-variable-importance"><i class="fa fa-check"></i><b>3.5</b> Estimate variable importance</a></li>
<li class="chapter" data-level="3.6" data-path="Chapter-Modeling.html"><a href="Chapter-Modeling.html#make-predictions-on-the-test-data-with-rf-model"><i class="fa fa-check"></i><b>3.6</b> Make predictions on the test data with rf model</a></li>
<li class="chapter" data-level="3.7" data-path="Chapter-Modeling.html"><a href="Chapter-Modeling.html#comparison-with-non-informative-classification"><i class="fa fa-check"></i><b>3.7</b> Comparison with non-informative classification</a></li>
<li class="chapter" data-level="3.8" data-path="Chapter-Modeling.html"><a href="Chapter-Modeling.html#train-data-set-backup-for-tn-specimens-selection"><i class="fa fa-check"></i><b>3.8</b> Train data set backup for TN specimens selection</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="Chapter-Perturbation.html"><a href="Chapter-Perturbation.html"><i class="fa fa-check"></i><b>4</b> Perturbation concept</a><ul>
<li class="chapter" data-level="4.1" data-path="Chapter-Perturbation.html"><a href="Chapter-Perturbation.html#objective-3"><i class="fa fa-check"></i><b>4.1</b> Objective</a></li>
<li class="chapter" data-level="4.2" data-path="Chapter-Perturbation.html"><a href="Chapter-Perturbation.html#data-set-and-useful-libraries"><i class="fa fa-check"></i><b>4.2</b> Data set and useful libraries</a></li>
<li class="chapter" data-level="4.3" data-path="Chapter-Perturbation.html"><a href="Chapter-Perturbation.html#perturbation-effect-of-some-elements-on-the-whole"><i class="fa fa-check"></i><b>4.3</b> Perturbation effect of some elements on the whole</a></li>
<li class="chapter" data-level="4.4" data-path="Chapter-Perturbation.html"><a href="Chapter-Perturbation.html#dissimilarity-index-between-compositions"><i class="fa fa-check"></i><b>4.4</b> Dissimilarity index between compositions</a></li>
<li class="chapter" data-level="4.5" data-path="Chapter-Perturbation.html"><a href="Chapter-Perturbation.html#rebalancing-a-misbalanced-sample-by-perturbation"><i class="fa fa-check"></i><b>4.5</b> Rebalancing a misbalanced sample by perturbation</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Assessment of the nutritional imbalance status of potato crop</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="header">
<h1 class="title">Assessment of the nutritional imbalance status of potato crop</h1>
<p class="author"><em>Zonlehoua Coulibali and Serge-Étienne Parent</em></p>
<p class="date"><em>2019-07-25</em></p>
</div>
<div id="Chapter-Data-Processing" class="section level1">
<h1><span class="header-section-number">Chapter 1</span> Data processing</h1>
<div id="objective" class="section level2">
<h2><span class="header-section-number">1.1</span> Objective</h2>
<hr />
<p>This chapter is the first of a series of R markdown codes aiming to describe computations methodology used to derive the results and conclusions of potato nutrient diagnosis article. The data set is a collection of potato surveys and nitrogen (N), phosphorous (P) and potassium (K) fertilizer trials conducted in Quebec from 1970 to 2017 between the US border at the 45^th parallel and the Northern limit of cultivation at the 49^th parallel. The useful variables are the first mature leaf (4^th from top, sampled at the beginning of blossom stage) nitrogen, phosphorus, potassium, calcium (Ca) and magnesium (Mg) compositions, cultivars used in experiments and tuber marketable yield. These variables are extracted from the Québec potato raw data table (<code>raw_potato_df.csv</code>) and tidded to obtain useful variables for cultivars clustering assessment (Chapter <a href="Chapter-Clustering.html#Chapter-Clustering">2</a>), tuber yield prediction (Chapter <a href="Chapter-Modeling.html#Chapter-Modeling">3</a>) and assessment of perturbation vector concept (Chapter <a href="Chapter-Perturbation.html#Chapter-Perturbation">4</a>). A previous exploration has shown that oligoelements contained too many missing values, for this reason these elements were excluded from analysis. The chapter ends with the backup of a processed data frame useful for next chapters.</p>
<hr />
</div>
<div id="useful-libraries-for-data-handling" class="section level2">
<h2><span class="header-section-number">1.2</span> Useful libraries for data handling</h2>
<p>I need package <a href="https://www.tidyverse.org/">tidyverse</a> which loads a set of packages for easy data manipulation and visualization. I used <a href="https://www.rdocumentation.org/packages/Amelia/versions/1.7.5">Amelia</a> for missing data vizualisation, <a href="https://www.rdocumentation.org/packages/robCompositions/versions/2.1.0">robCompositions</a> to robustely impute missing values in compositional data using knn methods, <a href="http://www.stat.boogaart.de/compositions">compositions</a> to transforme compositions into compositionnal space.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">&quot;tidyverse&quot;</span>)
<span class="kw">library</span>(<span class="st">&#39;Amelia&#39;</span>)
<span class="kw">library</span>(<span class="st">&quot;robCompositions&quot;</span>)
<span class="kw">library</span>(<span class="st">&quot;compositions&quot;</span>)</code></pre></div>
</div>
<div id="quebec-potato-data-set" class="section level2">
<h2><span class="header-section-number">1.3</span> Québec potato data set</h2>
<p>I load the Québec potato raw data set <code>raw_potato_df.csv</code> available for the project in the <code>data</code> folder.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">raw_potato_df &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="st">&quot;data/raw_potato_df.csv&quot;</span>)</code></pre></div>
</div>
<div id="selection-of-useful-variables" class="section level2">
<h2><span class="header-section-number">1.4</span> Selection of useful variables</h2>
<p>I create custom vectors of attributes which help select useful data columns for computations. The year of experiment is not needed instead it permits to know how long ago expériements have been monitored. Geographical coordinates will be needed to map experimental sites locations later.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">keys_col &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;NoEssai&#39;</span>, <span class="st">&#39;NoBloc&#39;</span>, <span class="st">&#39;NoTraitement&#39;</span>)
longNameMacro &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;AnalyseFoliaireN&quot;</span>,<span class="st">&quot;AnalyseFoliaireP&quot;</span>,<span class="st">&quot;AnalyseFoliaireK&quot;</span>, <span class="st">&quot;AnalyseFoliaireCa&quot;</span>,<span class="st">&quot;AnalyseFoliaireMg&quot;</span>)
extra_col &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;Annee&#39;</span>, <span class="st">&#39;LatDD&#39;</span>, <span class="st">&#39;LonDD&#39;</span>, <span class="st">&#39;AnalyseFoliaireStade&#39;</span>)
cultivarAndyield &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;Cultivar&#39;</span>, <span class="st">&#39;Maturity5&#39;</span>, <span class="st">&#39;RendVendable&#39;</span>)
useful_col &lt;-<span class="st"> </span><span class="kw">c</span>(keys_col, extra_col, cultivarAndyield, longNameMacro)
macroElements &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;N&quot;</span>, <span class="st">&quot;P&quot;</span>, <span class="st">&quot;K&quot;</span>, <span class="st">&quot;Ca&quot;</span>, <span class="st">&quot;Mg&quot;</span>) <span class="co"># for simplicity</span></code></pre></div>
<p>The reduced data frame becomes <code>leaf_df</code> which stands for the diagnostic leaves macroelements composition data frame combining corresponding cultivars data, marketable yield, year of experiment and sites geographical coordinates.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">leaf_df &lt;-<span class="st"> </span>raw_potato_df <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(useful_col)
<span class="kw">colnames</span>(leaf_df)[<span class="kw">which</span>(<span class="kw">names</span>(leaf_df) <span class="op">%in%</span><span class="st"> </span>longNameMacro)] &lt;-<span class="st"> </span>macroElements
<span class="kw">glimpse</span>(leaf_df)</code></pre></div>
<pre><code>## Observations: 12,991
## Variables: 15
## $ NoEssai              &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,...
## $ NoBloc               &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2,...
## $ NoTraitement         &lt;dbl&gt; 1, 2, 3, 4, 5, 6, 7, 8, 1, 2, 3, 4, 5, 6,...
## $ Annee                &lt;dbl&gt; 2003, 2003, 2003, 2003, 2003, 2003, 2003,...
## $ LatDD                &lt;dbl&gt; 46.75306, 46.75306, 46.75306, 46.75306, 4...
## $ LonDD                &lt;dbl&gt; -72.33861, -72.33861, -72.33861, -72.3386...
## $ AnalyseFoliaireStade &lt;chr&gt; &quot;10% fleur&quot;, &quot;10% fleur&quot;, &quot;10% fleur&quot;, &quot;1...
## $ Cultivar             &lt;chr&gt; &quot;Goldrush&quot;, &quot;Goldrush&quot;, &quot;Goldrush&quot;, &quot;Gold...
## $ Maturity5            &lt;chr&gt; &quot;mid-season&quot;, &quot;mid-season&quot;, &quot;mid-season&quot;,...
## $ RendVendable         &lt;dbl&gt; 18.9442, 40.3518, 33.0379, 37.5505, 46.00...
## $ N                    &lt;dbl&gt; 3.805, 3.356, 3.657, 3.610, 4.983, 4.277,...
## $ P                    &lt;dbl&gt; 0.22, 0.20, 0.22, 0.18, 0.22, 0.21, 0.28,...
## $ K                    &lt;dbl&gt; 6.31, 6.85, 6.44, 5.36, 5.92, 6.73, 5.75,...
## $ Ca                   &lt;dbl&gt; 1.69, 1.31, 1.13, 1.30, 1.23, 1.38, 1.17,...
## $ Mg                   &lt;dbl&gt; 0.53, 0.21, 0.32, 0.50, 0.44, 0.45, 0.51,...</code></pre>
</div>
<div id="arranging-the-data-frame" class="section level2">
<h2><span class="header-section-number">1.5</span> Arranging the data frame</h2>
<p>I set trial number <code>NoEssai</code> as factor, relevel categorical <code>maturity order</code> variable and choose cultivar <code>Superior</code> as reference as it has the maximum number of observations. Then, abundance of cultivars is ploted.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">percentage &lt;-<span class="st"> </span><span class="kw">round</span>(<span class="kw">with</span>(leaf_df, <span class="kw">prop.table</span>(<span class="kw">table</span>(Cultivar)) <span class="op">*</span><span class="st"> </span><span class="dv">100</span>), <span class="dv">2</span>)
distribution &lt;-<span class="st"> </span><span class="kw">with</span>(leaf_df, <span class="kw">cbind</span>(<span class="dt">numbOfsamples =</span> <span class="kw">table</span>(Cultivar), <span class="dt">percentage =</span> percentage))
distribution &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="kw">cbind</span>(distribution, <span class="kw">rownames</span>(distribution)))
<span class="kw">colnames</span>(distribution)[<span class="dv">3</span>] &lt;-<span class="st"> &quot;Cultivar&quot;</span>
distribution<span class="op">$</span>numbOfsamples &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(<span class="kw">as.character</span>(distribution<span class="op">$</span>numbOfsamples))
distribution<span class="op">$</span>percentage &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(<span class="kw">as.character</span>(distribution<span class="op">$</span>percentage))</code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:cultivar-abundance"></span>
<img src="2019_Bookdown_files/figure-html/cultivar-abundance-1.png" alt="Repported cultivars abundance in the potato data frame." width="100%" />
<p class="caption">
Figure 1.1: Repported cultivars abundance in the potato data frame.
</p>
</div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">leaf_df<span class="op">$</span>NoEssai &lt;-<span class="st"> </span><span class="kw">as.factor</span>(leaf_df<span class="op">$</span>NoEssai)
leaf_df<span class="op">$</span>Cultivar &lt;-<span class="st">  </span><span class="kw">relevel</span>(<span class="kw">factor</span>(leaf_df<span class="op">$</span>Cultivar), <span class="dt">ref =</span> <span class="st">&quot;Superior&quot;</span>)
leaf_df<span class="op">$</span>Maturity5 &lt;-<span class="st"> </span><span class="kw">ordered</span>(leaf_df<span class="op">$</span>Maturity5, 
                            <span class="dt">levels =</span> <span class="kw">c</span>(<span class="st">&quot;early&quot;</span>,<span class="st">&quot;early mid-season&quot;</span>,
                                       <span class="st">&quot;mid-season&quot;</span>,<span class="st">&quot;mid-season late&quot;</span>,<span class="st">&quot;late&quot;</span>))</code></pre></div>
<p>I portrait missing values for the sake of imputation. As explained in the section <a href="#Objective"><strong>??</strong></a>, I will retain after this processing only reasonably imputable data i.e., missing data of a sample less than half the number of studied attributes. The next cell maps the portrait of missing values.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">leafIonome &lt;-<span class="st"> </span>leaf_df[macroElements]
<span class="kw">missmap</span>(leafIonome)</code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:matrix-missing-comp"></span>
<img src="2019_Bookdown_files/figure-html/matrix-missing-comp-1.png" alt="Portrait of missing macroelements." width="100%" />
<p class="caption">
Figure 1.2: Portrait of missing macroelements.
</p>
</div>
<p>This figure compiles the samples identifiers on the Y axis and macroelements on the X axis. A complete horizontal unique color band indicates wether the 5 elements are totally observed (blue band) or totally missing (red band). Only N and P have missing values that will be imputed and retained at the end. The totally missing compositions will be removed. The next cell initializes this process.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># keep track of empty rows:</span>
leaf_df<span class="op">$</span>leaf_allNA &lt;-<span class="st"> </span><span class="kw">apply</span>(leaf_df[macroElements], <span class="dv">1</span>, <span class="cf">function</span>(X) <span class="kw">all</span>(<span class="kw">is.na</span>(X)))
<span class="co"># keep track of rows where there is any NA:</span>
leaf_df<span class="op">$</span>leaf_anyNA &lt;-<span class="st"> </span><span class="kw">apply</span>(leaf_df[macroElements], <span class="dv">1</span>, <span class="cf">function</span>(X) <span class="kw">any</span>(<span class="kw">is.na</span>(X)))
<span class="co"># number of NAs (missing values):</span>
leaf_df<span class="op">$</span>leaf_countNA &lt;-<span class="st"> </span><span class="kw">apply</span>(leaf_df[macroElements], <span class="dv">1</span>, <span class="cf">function</span>(X) <span class="kw">sum</span>(<span class="kw">is.na</span>(X)))</code></pre></div>
<p>The next cell performs the imputation. Since the imputation is a time-consuming process, we saved it in a <code>csv</code> stored in the subfolder <code>output</code> and have put a switch to put on if one wants to perform the computation again. The imputation is made by KNNs in the Aitchison (compositions-friendly) metric for rows where there are 1 or 2 missing values, i.e. <code>filter(leaf_countNA &lt;= 3)</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Warning: could be a long process</span>
perform_imputation &lt;-<span class="st"> </span><span class="ot">FALSE</span> <span class="co"># set to FALSE if you want to load the saved file</span>
<span class="cf">if</span> (perform_imputation) {
  <span class="kw">set.seed</span>(<span class="dv">628125</span>)
  leaf_imp &lt;-<span class="st"> </span>leaf_df <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">filter</span>(leaf_countNA <span class="op">&lt;=</span><span class="st"> </span><span class="dv">3</span>) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">select</span>(macroElements) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">impKNNa</span>(<span class="kw">as.matrix</span>(.),
            <span class="dt">metric =</span> <span class="st">&quot;Aitchison&quot;</span>, 
            <span class="dt">k =</span> <span class="dv">6</span>, 
            <span class="dt">primitive =</span> <span class="ot">TRUE</span>,
            <span class="dt">normknn =</span> <span class="ot">TRUE</span>, 
            <span class="dt">adj =</span> <span class="st">&#39;median&#39;</span>)
  leaf_complete &lt;-<span class="st"> </span>leaf_df <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">select</span>(macroElements)
  leaf_complete[leaf_df<span class="op">$</span>leaf_countNA <span class="op">&lt;=</span><span class="st"> </span><span class="dv">3</span>, ] &lt;-<span class="st"> </span>leaf_imp<span class="op">$</span>xImp
  <span class="kw">names</span>(leaf_complete) &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="kw">names</span>(leaf_complete), <span class="st">&quot;_imp&quot;</span>)
  <span class="kw">write_csv</span>(leaf_complete, <span class="st">&quot;output/leaf_complete.csv&quot;</span>)
} <span class="cf">else</span> {
  leaf_complete &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="st">&quot;output/leaf_complete.csv&quot;</span>)
}</code></pre></div>
<pre><code>## Parsed with column specification:
## cols(
##   N_imp = col_double(),
##   P_imp = col_double(),
##   K_imp = col_double(),
##   Ca_imp = col_double(),
##   Mg_imp = col_double()
## )</code></pre>
<p>With the next cell I append imputed columns to the data frame. The nutrients diagnosis will be done with imputed compositions.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">leaf_df &lt;-<span class="st"> </span><span class="kw">bind_cols</span>(leaf_df, leaf_complete)
leaf_df &lt;-<span class="st"> </span>leaf_df <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="op">-</span><span class="kw">c</span>(<span class="st">&quot;leaf_allNA&quot;</span>, <span class="st">&quot;leaf_anyNA&quot;</span>))</code></pre></div>
<p><a href="https://en.wikipedia.org/wiki/Compositional_data">Compositional data</a> are data where the elements of the composition are non-negative and sum to unity. I compute <code>Fv</code> standing for <code>filling value</code>, an amalgamation of all other elements closing the <a href="https://en.wikipedia.org/wiki/Simplex">simplex</a> to 100%.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">leaf_df &lt;-<span class="st"> </span>leaf_df <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">sum_imp =</span> <span class="kw">rowSums</span>(<span class="kw">select</span>(., <span class="kw">paste0</span>(macroElements, <span class="st">&quot;_imp&quot;</span>))),
         <span class="dt">Fv_imp =</span> <span class="dv">100</span> <span class="op">-</span><span class="st"> </span>sum_imp) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>sum_imp)
<span class="cf">if</span> (<span class="op">!</span><span class="st">&quot;Fv&quot;</span> <span class="op">%in%</span><span class="st"> </span>macroElements) macroElements &lt;-<span class="st"> </span><span class="kw">c</span>(macroElements, <span class="st">&quot;Fv&quot;</span>)</code></pre></div>
<p>I use centered log-ratio (<code>clr</code>) transformation for discriminant analysis and perturbation vector concept assessment.The next cell performs this calculation. The <code>clr</code> coordinates are computed in an external (intermediate) data table.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">leaf_composition &lt;-<span class="st"> </span>leaf_df <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(<span class="kw">paste0</span>(macroElements, <span class="st">&quot;_imp&quot;</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">acomp</span>(.)
leaf_clr &lt;-<span class="st"> </span><span class="kw">clr</span>(leaf_composition) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">unclass</span>() <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">as_tibble</span>()
<span class="kw">names</span>(leaf_clr) &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;clr_&quot;</span>, macroElements)
<span class="kw">write_csv</span>(leaf_clr, <span class="st">&quot;output/leaf_clr.csv&quot;</span>)</code></pre></div>
<p>The next cell binds these clr-transformed compositions to the raw composition data frame and retains useful columns. I also used this cell to discard all the samples with too many missing compositions.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">leaf_df &lt;-<span class="st"> </span><span class="kw">bind_cols</span>(leaf_df, leaf_clr)
leaf_df &lt;-<span class="st"> </span>leaf_df <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(keys_col, extra_col, cultivarAndyield, <span class="st">&quot;leaf_countNA&quot;</span>, <span class="kw">starts_with</span>(<span class="st">&quot;clr&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(leaf_countNA <span class="op">&lt;=</span><span class="st"> </span><span class="dv">3</span>)</code></pre></div>
</div>
<div id="cultivar-classes-correction" class="section level2">
<h2><span class="header-section-number">1.6</span> Cultivar classes correction</h2>
<p>From a previous checking, I noticed that cultivars <code>Mystere</code> and <code>Vivaldi</code> have different repported maturity classes in the data set, <code>mid-season late</code> and <code>late</code> for <code>Mystere</code>, then <code>early mid-season</code> and <code>mid-season</code> for <code>Vivaldi</code> respectively. Their new maturity classes names are based on a majority vote for this study. The next cell perform this correction. I also make missing values explicit for this categorical variable.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">leaf_df<span class="op">$</span>Maturity5[leaf_df<span class="op">$</span>Cultivar <span class="op">==</span><span class="st"> &quot;Mystere&quot;</span>] &lt;-<span class="st"> &quot;late&quot;</span>
leaf_df<span class="op">$</span>Maturity5[leaf_df<span class="op">$</span>Cultivar <span class="op">==</span><span class="st"> &quot;Vivaldi&quot;</span>] &lt;-<span class="st"> &quot;early mid-season&quot;</span>
leaf_df<span class="op">$</span>Cultivar &lt;-<span class="st"> </span>forcats<span class="op">::</span><span class="kw">fct_explicit_na</span>(leaf_df<span class="op">$</span>Cultivar) <span class="co"># makes missing values explicit.</span></code></pre></div>
</div>
<div id="summarise-and-backup" class="section level2">
<h2><span class="header-section-number">1.7</span> Summarise and backup</h2>
<p>Finally, I summarized the processed data frame to record the years of begining and ending of experiment, the remaining number of experiments, cultivars and maturity classes. The definitive leaves data frame is stored as <code>leaf_clust_df.csv</code> in <code>output</code> subfolder as it is an intermediate file, for cluster analysis (Chapter <a href="Chapter-Clustering.html#Chapter-Clustering">2</a>).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">leaf_df <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">start_year =</span> <span class="kw">min</span>(Annee, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>),
            <span class="dt">end_year =</span> <span class="kw">max</span>(Annee, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>),
            <span class="dt">numb_trials =</span> <span class="kw">n_distinct</span>(NoEssai, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>),
            <span class="dt">numb_cultivars =</span> <span class="kw">n_distinct</span>(Cultivar, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>),
            <span class="dt">numb_maturityClasses =</span> <span class="kw">n_distinct</span>(Maturity5, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>))</code></pre></div>
<pre><code>## # A tibble: 1 x 5
##   start_year end_year numb_trials numb_cultivars numb_maturityClasses
##        &lt;dbl&gt;    &lt;dbl&gt;       &lt;int&gt;          &lt;int&gt;                &lt;int&gt;
## 1       1970     2017        4714             59                    5</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">write_csv</span>(leaf_df, <span class="st">&#39;output/leaf_clust_df.csv&#39;</span>)</code></pre></div>

</div>
</div>
            </section>

          </div>
        </div>
      </div>

<a href="Chapter-Clustering.html" class="navigation navigation-next navigation-unique" aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"download": ["2019_Bookdown.pdf", "2019_Bookdown.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
